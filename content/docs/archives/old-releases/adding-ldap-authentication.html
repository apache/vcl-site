<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>


  <link href="/css/vcl.css" rel="stylesheet" type="text/css">
  <link href="/css/code.css" rel="stylesheet" type="text/css">
  <title>Apache VCL - Adding LDAP Authentication</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
</head>

<body>
  <div id="sitetitle">
    <table width="100%" border="0" cellspacing="0" cellpadding="5">
      <tr>
         <td><a href="/index.html"><img src="/img/vcl-logo.png" height="100" align="left" alt="Apache VCL logo"></a></td>
         <td><a href="http://www.apache.org"><img src="/img/asf-logo.png" align="right" alt="Apache Software Foundation logo"></a></td>
      </tr>
    </table>
  </div>
  
  <div id="left-column">
    <div id="navigation">
      <ul>
<li><a href="/index.html">Information</a>
<ul>
<li><a href="/info/features.html">Features</a></li>
<li><a href="/info/architecture.html">Architecture</a></li>
<li><a href="/downloads/download.cgi">Download</a></li>
<li><a href="http://www.apache.org/licenses/">License</a></li>
<li><a href="http://www.apache.org/security/">Security</a></li>
</ul>
</li>
<li><a href="/docs/index.html">Documentation</a>
<ul>
<li><a href="https://cwiki.apache.org/confluence/x/yQdG">Using VCL</a></li>
<li><a href="https://cwiki.apache.org/confluence/x/ywdG">Administration</a></li>
<li><a href="/docs/installation.html">Installation</a></li>
</ul>
</li>
<li><a href="https://cwiki.apache.org/confluence/display/VCL/Apache+VCL" target="_blank">Confluence Wiki</a>
  <ul>
      <li></li>
  </ul>
</li>
<li><a href="https://issues.apache.org/jira/browse/VCL" target="_blank">Jira Issue Tracking</a>
  <ul>
      <li></li>
  </ul>
</li>
<li><a href="/comm/index.html">Community</a>
<ul>
<li><a href="/comm/index.html#getInvolved">Getting Involved</a></li>
<li><a href="/comm/index.html#mail-list">Mailing Lists</a></li>
<li><a href="/dev/index.html">Development</a>
<ul>
<li><a href="/dev/code-documentation.html">Code Documentation</a></li>
<li><a href="/dev/roadmap.html">Roadmap</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="http://www.apache.org">Apache Software Foundation</a>
<ul>
<li><a href="http://www.apache.org/foundation/thanks.html">Thanks</a></li>
<li><a href="http://www.apache.org/foundation/sponsorship.html">Sponsorship</a></li>
</ul>
</li>
</ul>
    </div>
    <div id="current-event"> 
      <a  href="https://www.apache.org/events/current-event.html">
        <img src="https://www.apache.org/events/current-event-125x125.png" alt="Apache current event" />
      </a>
    </div>
  </div>
  
  <div id="content">
    <h1 class="title">Adding LDAP Authentication</h1>
    
	<p><a name="AddingLDAPAuthentication-PrerequisitesforyourLDAPserver:"></a></p>
<h3 id="prerequisites-for-your-ldap-server">Prerequisites for your LDAP server:</h3>
<ul>
<li>enable SSL on your LDAP server</li>
<li>Create an account that can look up a user&rsquo;s first and last names, user
id, and email address (email address is optional) - this will be referred
to as &lsquo;vcllookup&rsquo; on this page. You can skip this step if anonymous binds
are enabled on your LDAP server and an anonymous bind will be able to look
up userids, names, and email addresses.</li>
<li>if your LDAP server is firewalled, you will need to allow your VCL web
server to access tcp port 636 on your LDAP server</li>
</ul>
<p><a name="AddingLDAPAuthentication-PrerequisitesforyourVCLwebserver:"></a></p>
<h3 id="prerequisites-for-your-vcl-web-server">Prerequisites for your VCL web server:</h3>
<ul>
<li>
<p>php-ldap needs to be installed</p>
</li>
<li>
<p>If your LDAP server SSL certificate is self-signed, your VCL web server
needs to have the root CA certificate that was used to sign the LDAP server
certificate installed. On CentOS, information about the certificate needs
to be added to /etc/pki/tls/certs/ca-bundle.crt - this <a href="adding-ldap-authentication%5Econvert_crt_for_ldapssl.html">script</a>
will take as input a file containing the base64 encoded certificate and
generate the lines that need to be added to the ca-bundle.crt file.</p>
</li>
<li>
<p>After adding the certificate, restart httpd:</p>
<pre><code>  service httpd restart
</code></pre>
</li>
<li>
<p>You can verify that the certificate is properly installed using this
command:</p>
<pre><code>  openssl s_client -showcerts -CAfile /etc/pki/tls/certs/ca-bundle.crt -connect your.ldap.server.here:636
</code></pre>
<p>If you see &ldquo;Verify return code: 0 (ok)&rdquo; at the end of the output, then it
is installed correctly. If you see a different return code, then you&rsquo;ll
need to work through the problem.</p>
</li>
<li>
<p>You may need to add a line to /etc/openldap/ldap.conf to point to the
ca-bundle.crt file. I&rsquo;m not sure of a good way to tell if you need it or
not, but if you do, add the following:</p>
<p>TLS_CACERT /etc/pki/tls/certs/ca-bundle.crt</p>
</li>
</ul>
<p><a name="AddingLDAPAuthentication-AddingLDAPAuthenticationtotheWebCode"></a></p>
<h3 id="adding-ldap-authentication-to-the-web-code">Adding LDAP Authentication to the Web Code</h3>
<ul>
<li>
<p>You will need to manually add an entry to the affiliation table in the
vcl database. You need to come up with a name for the affiliation. This
will be appended to all userids for the affiliation to distinguish them
from other affiliations you may configure later. Initials or a short name
of your organization are a good idea. This cannot contain spaces. Use the
following to add the affiliation, replacing &lsquo;EXAMPLE&rsquo; with the name you
chose. Take note of the id from the 2nd SQL statement as you will need it
later. It is the affiliationid for this affiliation.</p>
<pre><code>  mysql vcl
  INSERT INTO affiliation (name) VALUES ('EXAMPLE');
  SELECT id FROM affiliation WHERE name = 'EXAMPLE';
  exit
</code></pre>
</li>
<li>
<p>Edit conf.php and search for &ldquo;EXAMPLE1 LDAP&rdquo;</p>
</li>
<li>
<p>Uncomment the &ldquo;EXAMPLE1 LDAP&rdquo; section by removing the &lsquo;/*&rsquo; before it and
the &lsquo;*/&rsquo; at the end of &lsquo;to use this login mechanism&rsquo;</p>
</li>
<li>
<p>Change &lsquo;EXAMPLE1 LDAP&rsquo; to something to match your location, for example
at NCSU, it is &lsquo;NCSU LDAP&rsquo;. This string is what users will see where they
select the authentication mechanism to use when logging in.</p>
</li>
<li>
<p>Modify the following fields:</p>
<ul>
<li>server - this is the hostname of your LDAP server</li>
<li>binddn - typically, you&rsquo;ll want to use the base DN of your LDAP server;
for Active Directory, this is usually dc= for each of your domain name
components. For example, your your domain name was ad.example.org, it would
be &ldquo;dc=ad,dc=example,dc=org&rdquo;</li>
<li>userid - this is a string that is added to the userid a user enters on
the login page. Place a &lsquo;%s&rsquo; where the entered userid should go. Some
examples are:
<ul>
<li>%s@example.org</li>
<li>%s@ad.example.org</li>
<li>uid=%s,ou=accounts,dc=example,dc=org&rsquo;</li>
</ul>
</li>
<li>unityid - this is the ldap field that contains a user&rsquo;s login id (for
Active Directory, this is usually sAMAccountName)</li>
<li>firstname - this is the ldap field that contains a user&rsquo;s first name</li>
<li>lastname - this is the ldap field that contains a user&rsquo;s last name</li>
<li>email - this is the ldap field that contains a user&rsquo;s email address</li>
<li>defaultemail - if an email address is not provided by the ldap server,
this will be appended to the end of the userid to create an email address.
In this case, email notifications will be disabled by default.</li>
<li>masterlogin - this is the vcllookup account referred to in the
&ldquo;Prerequisites for your LDAP server&rdquo; section - comment out this line if
using anonymous binds</li>
<li>masterpwd - password for the masterlogin account - comment out this line
if using anonymous binds</li>
<li>affiliationid - this is the id from the SELECT statement in the first
step</li>
<li>help - this is some text that will show up on the page where users
select the authentication method explaining why they would select this
option</li>
</ul>
</li>
<li>
<p>Next, there are 6 arrays that would need to be modified, but can be
replaced with a block of code.</p>
</li>
<li>
<p>Delete the following lines:</p>
<pre><code>  $affilValFunc = array(1 =&gt; create_function('', 'return 0;'),
                /*3 =&gt; &quot;validateLDAPUser&quot;,*/
  );
    
  $affilValFuncArgs = array(/*3 =&gt; 'EXAMPLE1 LDAP',*/
  );
    
  $addUserFunc = array(1 =&gt; create_function('', 'return 0;'),
               /*3 =&gt; 'addLDAPUser',*/
  );
    
  $addUserFuncArgs = array(/*3 =&gt; 'EXAMPLE1 LDAP',*/
  );
    
  $updateUserFunc = array(1 =&gt; create_function('', 'return 0;'),
              /*3 =&gt; 'updateLDAPUser',*/
  );
    
  $updateUserFuncArgs = array(/*3 =&gt; 'EXAMPLE1 LDAP',*/
  );
</code></pre>
</li>
</ul>
<p>and replace them with</p>
<pre><code>    $affilValFunc = array();
    $affilValFuncArgs = array();
    $addUserFunc = array();
    $addUserFuncArgs = array();
    $updateUserFunc = array();
    $updateUserFuncArgs = array();
    foreach($authMechs as $key =&gt; $item) {
       if($item['type'] == 'ldap') {
          $affilValFunc[$item['affiliationid']] = 'validateLDAPUser';
          $affilValFuncArgs[$item['affiliationid']] = $key;
          $addUserFunc[$item['affiliationid']] = 'addLDAPUser';
          $addUserFuncArgs[$item['affiliationid']] = $key;
          $updateUserFunc[$item['affiliationid']] = 'updateLDAPUser';
          $updateUserFuncArgs[$item['affiliationid']] = $key;
       }
       elseif($item['type'] == 'local') {
          $affilValFunc[$item['affiliationid']] = create_function('', 'return 0;');
          $addUserFunc[$item['affiliationid']] = create_function('', 'return 0;');
          $updateUserFunc[$item['affiliationid']] = create_function('', 'return 0;');
       }
    }
</code></pre>
<ul>
<li>uncomment the require_once line for ldapauth.php toward the bottom of the
file</li>
</ul>
<p><a name="AddingLDAPAuthentication-TweakifyourLDAPserverhasusersinmultiplecontainers"></a></p>
<h3 id="tweak-if-your-ldap-server-has-users-in-multiple-containers">Tweak if your LDAP server has users in multiple containers</h3>
<p>If your LDAP server has users in multiple containers, then the full DN for
each user must be looked up before doing a bind to the LDAP server to
authenticate the user. In this case, you&rsquo;ll need to modify
authentication.php.</p>
<ul>
<li>edit authenciation.php</li>
<li>search for ldapLogin</li>
<li>search for EXAMPLE1 LDAP in the function</li>
<li>uncomment the block of code it is contained in by removing the &lsquo;/*&rsquo; at the beginning of the line containing &lsquo;EXAMPLE1 LDAP&rsquo;, and removing the &lsquo;*/&rsquo; at the end of the else that is before &lsquo;$ldapuser = sprintf($authMechs[$authtype][&lsquo;userid&rsquo;], $userid);&rsquo;</li>
<li>Look for the line containing &lsquo;cn=$userid&rsquo;. If you use &lsquo;cn&rsquo; to look up
userids in your LDAP server, the line is fine as is. If you use something
else, such as &lsquo;uid&rsquo;, change &lsquo;cn&rsquo; to &lsquo;uid&rsquo; or whatever is used on your LDAP
server.</li>
<li>save the file</li>
</ul>


  </div>
  
  <div id="footer">
    <div class="copyright">
      <p>
        Copyright &copy; 2020 The Apache Software Foundation, Licensed under
        the <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a>.
        <br />
        Apache and the Apache feather logo are trademarks of The Apache Software Foundation.
      </p>
    </div>
  </div>
  
</body>
</html>
