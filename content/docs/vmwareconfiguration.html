<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>


  <link href="/css/vcl.css" rel="stylesheet" type="text/css">
  <link href="/css/code.css" rel="stylesheet" type="text/css">
  <title>Apache VCL - VMware Configuration</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
</head>

<body>
  <div id="sitetitle">
    <table width="100%" border="0" cellspacing="0" cellpadding="5">
      <tr>
         <td><a href="/index.html"><img src="/img/vcl-logo.png" height="100" align="left" alt="Apache VCL logo"></a></td>
         <td><a href="http://www.apache.org"><img src="/img/asf-logo.png" align="right" alt="Apache Software Foundation logo"></a></td>
      </tr>
    </table>
  </div>
  
  <div id="left-column">
    <div id="navigation">
      <ul>
<li><a href="/index.html">Information</a>
<ul>
<li><a href="/info/features.html">Features</a></li>
<li><a href="/info/architecture.html">Architecture</a></li>
<li><a href="/downloads/download.cgi">Download</a></li>
<li><a href="http://www.apache.org/licenses/">License</a></li>
<li><a href="http://www.apache.org/security/">Security</a></li>
</ul>
</li>
<li><a href="/docs/index.html">Documentation</a>
<ul>
<li><a href="https://cwiki.apache.org/confluence/x/yQdG">Using VCL</a></li>
<li><a href="https://cwiki.apache.org/confluence/x/ywdG">Administration</a></li>
<li><a href="/docs/installation.html">Installation</a></li>
</ul>
</li>
<li><a href="https://cwiki.apache.org/confluence/display/VCL/Apache+VCL" target="_blank">Confluence Wiki</a>
  <ul>
      <li></li>
  </ul>
</li>
<li><a href="https://issues.apache.org/jira/browse/VCL" target="_blank">Jira Issue Tracking</a>
  <ul>
      <li></li>
  </ul>
</li>
<li><a href="/comm/index.html">Community</a>
<ul>
<li><a href="/comm/index.html#getInvolved">Getting Involved</a></li>
<li><a href="/comm/index.html#mail-list">Mailing Lists</a></li>
<li><a href="/dev/index.html">Development</a>
<ul>
<li><a href="/dev/code-documentation.html">Code Documentation</a></li>
<li><a href="/dev/roadmap.html">Roadmap</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="http://www.apache.org">Apache Software Foundation</a>
<ul>
<li><a href="http://www.apache.org/foundation/thanks.html">Thanks</a></li>
<li><a href="http://www.apache.org/foundation/sponsorship.html">Sponsorship</a></li>
</ul>
</li>
</ul>
    </div>
    <div id="current-event"> 
      <a  href="https://www.apache.org/events/current-event.html">
        <img src="https://www.apache.org/events/current-event-125x125.png" alt="Apache current event" />
      </a>
    </div>
  </div>
  
  <div id="content">
    <h1 class="title">VMware Configuration</h1>
    
	<h2 id="terminology">Terminology</h2>
<p><strong>VM Host</strong></p>
<ul>
<li>A VM host is a physical computer running a VMware hypervisor</li>
<li>A VCL computer entry must be added for each VM host (Manage Computers &gt; Edit Computer Information)</li>
<li>After the computer has been added to VCL, it is designated as a VM host by changing the computer state to vmhostinuse (Manage Computers &gt; Computer Utilities)</li>
</ul>
<p><strong>VM</strong></p>
<ul>
<li>A VM is a virtual machine managed by VCL</li>
<li>A computer entry must be added to VCL for each VM (Manage Computers &gt; Edit Computer Information)</li>
<li>Each VM must be assigned to a VM host (Virtual Hosts &gt; VM Hosts tab &gt; Configure Host)</li>
<li>VMs do not need to be created manually in VMware, VCL automatically creates and deletes VMs</li>
</ul>
<p><strong>VM Host Profile</strong></p>
<ul>
<li>A VM host profile contains several parameters which describe how a VM host is configured so that VCL knows how to manage it</li>
<li>Each VM host is assigned a VM host profile</li>
<li>A VM host profile may be assigned to multiple VM hosts if they are configured identically</li>
<li>VM host profiles may be added or modified via Virtual Hosts &gt; VM Host Profiles tab</li>
</ul>
<p><strong>VMware Products Supported</strong></p>
<ul>
<li>VMware Server 2.x</li>
<li>VMware ESX 3.5 - 4.x</li>
<li>VMware ESXi 4.x</li>
<li>VMware ESXi 5.x</li>
</ul>
<hr>
<h2 id="vm-host-management-options">VM Host Management Options</h2>
<p>The VCL management node must be able to control the VM host and the VMs running on it.  VMware provides several different ways of doing this.  VCL currently supports the following methods for remote VM host management:</p>
<ul>
<li>VMware vSphere SDK</li>
<li>Use SSH to execute commands directly on the VM (not officially supported by VMware)</li>
</ul>
<p>The vSphere SDK can only be used if management is not restricted due to the VMware license key installed on the host.  This mainly affects hosts running the free version of ESXi.  Remote management using any of the methods supported by VMware is restricted once a free license key is entered.</p>
<p>If remote management is restricted, the VM host can be managed if SSH is enabled on it.  VCL will execute vim-cmd and other commands on the VM host via SSH.</p>
<h2 id="how-to-enable-ssh-on-the-vm-host">How to enable SSH on the VM host:</h2>
<p><strong>VMware Server 2.x</strong></p>
<p>Enable the SSH daemon and configure identity key authentication according to the underlying VM host OS</p>
<p><strong>ESX/ESXi 3.5 &amp; 4.0</strong></p>
<ul>
<li>Connect to the console of the ESX/ESXi host</li>
<li>Press ALT-F1 - you should see a black screen with the VMware product name at the top</li>
<li>Type the word unsupported and press Enter (you won&rsquo;t see the letters appear as you type them)</li>
<li>You should see a password prompt, type in the root password and press Enter</li>
<li>Edit the file: vi /etc/inetd.conf</li>
<li>Uncomment the first line beginning with #ssh by deleting the # character</li>
<li>Save the file - press Esc and then :wq</li>
<li>Kill the inetd process</li>
<li>Determine the PID of the inetd process: ps | grep inetd</li>
<li>You should see a line that looks like: 5065 5065 busybox inetd</li>
<li>Kill the process (enter the PID from the output of the previous command): kill -HUP 5065</li>
</ul>
<p><strong>ESXi 4.1</strong></p>
<p>Beginning with ESXi 4.1, SSH can be enabled using the vSphere Client:</p>
<ul>
<li>Select the ESXi host</li>
<li>Select the Configuration tab</li>
<li>Select Security Profile under Software</li>
<li>Click Properties</li>
<li>Select Remote Tech Support (SSH)</li>
<li>Click Options</li>
<li>Select Start automatically</li>
<li>Click Start</li>
<li>Click OK</li>
</ul>
<p><strong>ESX 5.0</strong></p>
<p>In the case of ESX 5.0:</p>
<ul>
<li>Select the ESXi host</li>
<li>Select the Configuration tab</li>
<li>Select Security Profile under Software</li>
<li>Click Properties</li>
<li>Select SSH Server</li>
<li>Click Options</li>
<li>Confirm that Start automatically is selected</li>
<li>Click OK</li>
</ul>
<hr>
<h3 id="how-to-configure-esxesxi-to-use-ssh-identity-key-authentication">How to configure ESX/ESXi to use SSH identity key authentication:</h3>
<p>SSH identity key authentication must be configured if SSH is used to manage the VM host.</p>
<ul>
<li>
<p>Create an SSH key pair on the management node (or use a key you previously created):</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ssh-keygen -t rsa -f /etc/vcl/vcl.key -N <span style="color:#b44">&#39;&#39;</span> -b <span style="color:#666">1024</span> -C <span style="color:#b44">&#39;VCL root account&#39;</span>
</code></pre></div></li>
<li>
<p>Log into the ESX host via SSH (password authentication should work) and create the directory:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ssh &lt;ESXi host&gt; <span style="color:#b44">&#39;mkdir /.ssh&#39;</span>
</code></pre></div></li>
<li>
<p>Copy the public key to the ESXi host:</p>
<ul>
<li>
<p>ESXi 4.x:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">scp /etc/vcl/vcl.key.pub ESXi host:/.ssh/authorized_keys
</code></pre></div></li>
<li>
<p>ESXi 5.x:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">scp /etc/vcl/vcl.key.pub ESXi host:/etc/ssh/keys-root/authorized_keys
</code></pre></div></li>
</ul>
</li>
<li>
<p>Test making an SSH connection using the key:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ssh -i /etc/vcl/vcl.key &lt;ESXi host&gt;
</code></pre></div></li>
</ul>
<p><strong>IMPORTANT</strong>: Under ESXi 4.x, the authorized_keys file is erased when the ESXi VM host is rebooted. Complete the following steps to make the authorized_keys file persistent:</p>
<p><em>Note</em>: VCL will perform these steps automatically when the 1st reservation assigned to the host is processed.</p>
<ul>
<li>
<p>Create a compressed tarball file containing the /.ssh directory:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">tar -C / -czf bootbank/vcl.tgz .ssh
</code></pre></div></li>
<li>
<p>Edit the /bootbank/boot.cfg file and append ' &mdash; <strong>vcl.tgz</strong>&rsquo; to modules line as shown in the following example:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">kernel=b.z
kernelopt=
modules=k.z — s.z — c.z — oem.tgz — license.tgz — m.z — state.tgz — vcl.tgz
build=4.1.0-260247
updated=2
bootstate=0
</code></pre></div><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">Optionally you can run the following two commands:
tar -C / -czf bootbank/vcl.tgz .ssh
BootModuleConfig.sh --add<span style="color:#666">=</span>vcl.tgz --verbose
</code></pre></div></li>
</ul>
<h2 id="vm-host-profile-parameters">VM Host Profile Parameters</h2>
<p><strong>General Parameters</strong></p>
<p><strong>Name</strong></p>
<ul>
<li>Descriptive name of the VM host profile</li>
</ul>
<p><strong>Type (deprecated)</strong></p>
<ul>
<li>Removed in VCL 2.3</li>
</ul>
<p><strong>Image (optional)</strong></p>
<ul>
<li>VCL hypervisor image installed on VM host computers using xCAT
 <div class="docnote">
 xCAT is not required.  VM host computers may be installed manually or by some other means.
 </div>
</li>
<li>If xCAT is not used, select &ldquo;No Image&rdquo;</li>
<li>VCL has the ability to install a hypervisor image on bare-metal computers using xCAT.  If the image property is configured, the image is installed when a computer&rsquo;s state is changed to vmhostinuse via Manage Computers &gt; Computer Utilities</li>
</ul>
<p><strong>Username/Password (optional)</strong></p>
<ul>
<li>Name and password of the administrative or root user residing on the VM host</li>
<li>This account is used to manage the VM host and VMs assigned to the host</li>
<li>The username and password are currently only used if the vSphere SDK is used to manage the VM host and VMs</li>
</ul>
<h3 id="storage-parameters">Storage Parameters</h3>
<p><strong>Resource Path (optional)</strong></p>
<p>Resource Path only needs to be configured if VMware vCenter is used. It defines the location where VMs will be created in the vCenter inventory tree. The inventory tree contains at least one Datacenter, and may also contain Folders, Clusters, and Resource Pools.
Example: /DatacenterA/Folder1/Cluster2/ResourcePool3</p>
<ul>
<li>Path where master copies of images are stored which are used to transfer images to VM host datastores or to other repositories:
<ul>
<li>If a reservation is assigned to a host but the image does not exist in that host&rsquo;s datastore, it is copied from the repository to the virtual disk path when the VM is loaded</li>
<li>If the VCL environment contains multiple management nodes and the image does not exist in the repository or the host&rsquo;s datastore, the image will be retrieved from another management node&rsquo;s repository by copying it via SCP</li>
</ul>
</li>
<li>The Repository Path parameter does not need to be configured if the VCL environment contains a single management node and all VM hosts share the same Virtual Disk Path</li>
<li>Example: /vmfs/volumes/nfs-repository1</li>
<li>VMs do not run directly off of the images stored in the repository</li>
<li>Setting the Repository Path parameter determines whether or not an additional copy of an image is created when an image is captured
<ul>
<li>If repository path is not configured then only a single copy of the image will exist in the virtual disk path after an image is captured</li>
<li>If repository path is configured then two copies of the image will exist after an image is captured - one in the virtual disk path and one in the repository</li>
</ul>
</li>
<li>Repository Path location can refer to and be mounted on either the management node or VM host
<ul>
<li>It is highly recommended that the repository be mounted on the VM host
<ul>
<li>When mounted on the VM host, vmdk operations can be done directly on the VM host in a single step</li>
</ul>
</li>
</ul>
</li>
<li>Images in the repository are stored in the 2 GB sparse vmdk format
<ul>
<li>The size of the vmdk files will approximately be equal to the amount of actual data saved in the image regardless of the size of the VM&rsquo;s hard drive</li>
<li>Storing images in the 2 GB sparse format is necessary to allow images to be transferred via SCP without having to transfer data equal to the entire size of the VM&rsquo;s hard drive</li>
</ul>
</li>
</ul>
<p><strong>Repository Image Type</strong></p>
<p>Virtual disk file format for images stored in the repository.</p>
<p><strong>Virtual Disk Path (previously Datastore Path)</strong></p>
<ul>
<li>Location where master copies of images are stored which are used by running VMs</li>
<li>Example: /vmfs/volumes/nfs-datastore1
For ESXi, the path configured in the profile may simply be the short datastore name as it appears in the vSphere Client: nfs-datastore1</li>
<li>Storage location should be large enough to store all of the images which may be loaded on the VM host (from 100&rsquo;s of GB to several TB)</li>
<li>VCL creates a directory for each image in the Virtual Disk Path</li>
<li>Images are stored in the vmfs thin vmdk format</li>
<li>Virtual Disk Path may either reside on local or network storage</li>
<li>Multiple VM hosts can share the same datastore if network storage is used
<ul>
<li>A single datastore may be used by all VM hosts if performance is adequate</li>
<li>Multiple VMs on different hosts may access the same Virtual Disk Path image at the same time</li>
<li>It is recommended that datastores are shared among hosts so that fewer copies of each image have to be stored</li>
<li>The underlying storage hardware and network connectivity from the hosts to the storage must be adequate</li>
<li>Storage where the datastore is located should be optimized for read performance</li>
</ul>
</li>
<li>VCL configures VMs to access images stored in the Virtual Disk Path in read-only mode
<ul>
<li>Changes made to the VM&rsquo;s hard drive are written to delta files located in the VM Working Directory Path dedicated for the VM</li>
</ul>
</li>
</ul>
<p><strong>Virtual Disk Image Type</strong></p>
<p>Virtual disk file format for images stored in the virtual disk path.</p>
<p><strong>Virtual Disk Mode (previously VM Disk)</strong></p>
<ul>
<li>
<p>Defines whether the storage where the VM host&rsquo;s Virtual Disk Path resides is dedicated to a single host or shared among multiple hosts:</p>
<ul>
<li>dedicated (previously localdisk)
<ul>
<li>The VM host&rsquo;s Virtual Disk Path is located on local disks or dedicated network storage</li>
<li>The VM host is the only host which accesses the Virtual Disk Path</li>
<li>Repository Path must be configured</li>
</ul>
</li>
<li>shared (previously networkdisk)
<ul>
<li>The VM host&rsquo;s Virtual Disk Path is located on network storage which is shared by other VM hosts</li>
<li>Repository Path is optional</li>
</ul>
</li>
</ul>
 <div class="docnote">
     The Virtual Disk Mode (VM Disk) parameter does not determine whether or not:
     ...images are copied from the datastore to the repository during image capture
     ...images are copied from the repository to the datastore during image load
     These are determined by whether or not Repository Path is configured in the profile
     </div>
</li>
</ul>
<p><strong>VM Working Directory Path (optional) (previously VM Path)</strong></p>
<ul>
<li>Defines path on VM host where VM working directories will reside (contains .vmx, delta, .vswp, nvram files)</li>
<li>If not configured, the Virtual Disk Path location will be used</li>
<li>VCL creates a directory under the VM Working Directory Path for each VM it creates
<ul>
<li>Contains the .vmx file which defines the VM</li>
<li>Contains delta vmdk files which are written to as changes are made to the VM&rsquo;s hard drive</li>
</ul>
</li>
<li>VM Working Directory Path may either reside on local or network storage</li>
<li>Location should be dedicated for each VM host
<ul>
<li>Multiple VM hosts should not share the same VM Working Directory Path location for performance and image safety reasons</li>
<li>VM Working Directory Paths of multiple hosts may reside on the same volume but a subdirectory should be created for each host</li>
</ul>
</li>
<li>Storage where the VM Working Directory Path is located should be optimized for read-write performance</li>
</ul>
<h3 id="networking-parameters">Networking Parameters</h3>
<p><strong>VM Network (previously Virtual Switch)</strong></p>
<ul>
<li>
<p>VM Network 0 (previously Virtual Switch 0) - private VCL management network</p>
</li>
<li>
<p>VM Network 1 (previously Virtual Switch 1) - public network used by user making reservation to access the VMs</p>
</li>
<li>
<p>The VM Network parameters should match the network names configured on the VM host</p>
<ul>
<li>For ESXi, the VM Network parameters must match the Virtual Machine Port Group Network Labels configured in the vSphere Client, example:
<ul>
<li>VM Network 0: Public</li>
<li>VM Network 1: Private</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="vmware-network-labels.gif" alt="vmware-network-labels"></p>
<ul>
<li>For VMware Server 2.x, the VM Network parameters must match the Network Names configured by running vmware-config.pl</li>
</ul>
<p><strong>Generate eth0/eth1 MAC</strong></p>
<ul>
<li>New in VCL 2.3</li>
<li>Determines whether VMs are assigned MAC addresses defined in the VCL database or if random MAC addresses should be assigned</li>
</ul>
<h3 id="configuration-examples">Configuration Examples</h3>
<p><strong>Local Disk Only - Repository Mounted via NFS</strong></p>
<p>The diagram above shows a simple VCL configuration with 1 management node and 2 VMware ESXi hosts.  Network storage is not used.</p>
<p><img src="local-only-nfs.gif" alt="local-only-nfs"></p>
<p>The local disks on the VM hosts are used to store all of the files used by running VMs including the VM&rsquo;s working directory and the master vmdk image.</p>
<p>A directory on the local disk on the management node is used to as the image repository.  This directory is exported via NFS.  VM hosts mount this directory as a datastore named &ldquo;repository&rdquo;.  Mounting the repository directly on the VM hosts allows the vmkfstools utility to be used on the VM hosts to copy and convert images directly from the repository to the local datastore in a single step.</p>
<p>If an image is to be loaded on a VM host and that image does not already exist in the VM host&rsquo;s local datastore (Virtual Disk Path), it is automatically copied from the repository to the VM host&rsquo;s local datastore (Virtual Disk Path) at the beginning of the load process.</p>
<p>During image capture, images are automatically copied to from the VM host&rsquo;s local datastore (Virtual Disk Path) to the repository.  This allows images captured on a VM host to be loaded on any other VM host.</p>
<p>The VM host profile Virtual Disk Mode parameter is set to dedicated.  This indicates to the load process that the VM host&rsquo;s Virtual Disk Path is dedicated to the VM host and not shared by other VM hosts.  This allows images to be deleted from the VM host&rsquo;s local datastore (Virtual Disk Path) if another image must be copied from the repository and not enough space is available.</p>
<p><strong>Local Disk Only - Repository Not Available via NFS</strong></p>
<p>This example is identical to the one above except that the repository located on the management node&rsquo;s local disk is not exported via NFS.</p>
<p><img src="local-only-scp.gif" alt="local-only-scp"></p>
<p>Because of this, images must be transferred using SCP instead of vmkfstools.  This is less desirable than mounting the repository directly on the VM hosts because images cannot be copied and converted in a single step.  Images are stored in the repository in the 2GB sparse format.  This allows the images to be copied via SCP while only transferring the data stored in the image, not the entire size of the hard drive stored in the image.  VMware ESXi cannot run VMs using vmdk images stored in the 2GB sparse format.  Images are converted to the vmfs thin format so that they can be loaded on VMware ESXi.  This adds extra time to the load process if an image does not exist in the VM&rsquo;s local datastore (Virtual Disk Path) and must be copied from the repository.  It also requires additional space in the VM host&rsquo;s local datastore (Virtual Disk Path) becuase 2 copies of the image exist while it is being converted.</p>
<p>Note that the VM host profile Repository Path parameter is set to the path on the management node&rsquo;s hard drive.  The code first checks if the path exists on the VM host.  If not, it assumes the repository is not mounted directly on the VM host and the Repository Path value refers to a location on the management node.</p>
<p><strong>Network Storage Only - No Repository</strong></p>
<p>This is an example of a simple configuration where the network storage is used.</p>
<p><img src="network-only-no-repo.gif" alt="network-only-no-repo"></p>
<p>A repository is not used in this configuration.  This implies that all VM hosts which will ever be added to this VCL environment will need to be able to connect to the network storage.</p>
<p>A datastore to be used as the Virtual Disk Path named &ldquo;datastore&rdquo; is mounted on every VM host.  Each of these mounts points to the same location on the network storage.  The datastore will contain the master vmdk images.  VMs loaded on the VM hosts will read from these master vmdk images.</p>
<p>A datastore to be used as the VM Working Directory Path named &ldquo;vmpath&rdquo; is also mounted on each VM host.  However, the location to which each VM host points should be different.  In the example above, vmhost-a-01 points to th the /vmpath01 directory on the network storage and vmhost-a-02 points to the /vmpath02 directory.  These locations may be different network storage filesystems or may be different directories on the same network filesystem.  Even though the mounts on the VM hosts point to different locations, the datastore names configured under ESXi are identical.  This allows you to use the same VCL VM host profile for all of the VM hosts.</p>
<p>The VM host profile Virtual Disk Mode parameter is set to shared.  This indicates to the load process that the VM host&rsquo;s Virtual Disk Path is shared by other VM hosts.</p>


  </div>
  
  <div id="footer">
    <div class="copyright">
      <p>
        Copyright &copy; 2020 The Apache Software Foundation, Licensed under
        the <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a>.
        <br />
        Apache and the Apache feather logo are trademarks of The Apache Software Foundation.
      </p>
    </div>
  </div>
  
</body>
</html>
